#!/bin/bash
# Test script for plan-gemini-review.py
# Real test case from session 8c049902

PLAN='{"tool_name": "ExitPlanMode", "session_id": "test-real-plan", "cwd": "/Users/ruohanc/Documents/GitHub/ai-review-plugins", "transcript_path": "/Users/ruohanc/.claude/transcripts/test-real-plan.jsonl", "tool_input": {"plan": "## Plan Content\n# 修复计划：test_integration_cli.py 验证不完整问题\n\n## Context\n\n验证报告 [docs/verification-report.md](docs/verification-report.md) 定义了 16 个测试场景的验证目标，但 [tests/test_integration_cli.py](tests/test_integration_cli.py) 存在以下问题：\n\n1. **格子数量一致性验证完全缺失** - 验证报告要求验证拆分前后瓦片总格子数一致\n2. **验证目标不完整** - 多个场景缺少关键断言（如 need_print 非空，成本比较等）\n3. **断言过于宽松** - 如 `total_used <= X` 这种边界宽松断言\n\n好消息：格子数验证函数已存在于 `tests/test_verification_scenarios.py` (第37-49行)，可以复用。\n\n---\n\n## 修复方案\n\n### 步骤 1: 添加验证函数（文件顶部）\n\n```python\ndef check_cell_count_consistency(tiles_before, tiles_after):\n    \"\"\"检查拆分前后格子数量是否一致\"\"\"\n    cells_before = sum(w * h for w, h in tiles_before)\n    cells_after = sum(w * h for w, h in tiles_after)\n    return cells_before == cells_after, cells_before, cells_after\n```\n\n### 步骤 2: 场景 1-3c：补全库存验证\n\n**TestScenario1** (已完整 ✅)\n\n**TestScenario2** (已完整 ✅)\n\n**TestScenario3a**: 补充库存使用验证\n```python\n# 当前已有：has_6x6, 时间比较\n# 需添加：check_inventory_not_exceeded(from_inv, inventory)\n```\n\n**TestScenario3b, 3c**: 同上\n\n### 步骤 3: 场景 4a-4d：加强断言\n\n| 场景 | 需添加验证 |\n|------|-----------|\n| 4a | 验证抽屉1使用了1个库存 |\n| 4b | 验证抽屉1成本=0 |\n| 4c | 验证抽屉2使用1个库存，库存刚好用完 |\n| 4d | 验证抽屉2至少使用1个库存 |\n\n### 步骤 4: 场景 5：完整验证（重点）\n\n```python\ndef test_replan_with_partial_inventory(self, tmp_path):\n    # ... 现有代码 ...\n\n    # 1. 格子数量一致性（关键！）\n    original_cells = 2 * 6 * 9  # 108格\n    new_cells = sum(t['width'] * t['height'] for t in tiles)\n    assert original_cells == new_cells, f\"格子数应一致: {original_cells} = {new_cells}\"\n\n    # 2. 验证需要打印（不是完全用库存）\n    inv_usage = plan.get('inventory_usage', {})\n    need_print = inv_usage.get('need_print', {})\n    assert need_print, \"应有打印需求\"\n\n    # 3. 验证成本降低（对比无库存方案）\n    # ...\n```\n\n### 步骤 5: 场景 6a-7b：添加格子数验证\n\n为以下测试类在批量计算后添加：\n```python\n# 对每个抽屉验证格子数一致\nfor drawer in drawers:\n    original_cells = drawer.get('original_cells', 0)\n    scheme_cells = sum(t['width'] * t['height'] for t in drawer.get('tiles', []))\n    assert original_cells == scheme_cells\n```\n\n### 步骤 6: 场景 8：加强验证\n\n```python\n# 当前：验证库存不超限\n# 需添加：验证所有抽屉都有打印（不是全部用库存）\nfor drawer in drawers:\n    drawer_inv = drawer.get('inventory_usage', {})\n    assert drawer_inv.get('need_print'), f\"抽屉{drawer}应有打印\"\n```\n\n---\n\n## 关键文件\n\n- [tests/test_integration_cli.py](tests/test_integration_cli.py) - 修改目标\n- [tests/test_verification_scenarios.py](tests/test_verification_scenarios.py) - 参考实现\n- [docs/verification-report.md](docs/verification-report.md) - 验证要求\n\n---\n\n## 验证\n\n```bash\n# 运行修复后的测试\n.venv/bin/python -m pytest tests/test_integration_cli.py -v\n\n# 预期：所有场景通过，覆盖验证报告所有验证目标\n```\n\n## 验收标准\n\n- 16个测试场景全部通过\n- 格子数量一致性验证覆盖所有场景\n- 库存验证无遗漏"}}'

echo "$PLAN" | python3 /Users/ruohanc/Documents/GitHub/ai-review-plugins/scripts/plan-gemini-review.py 2>&1
