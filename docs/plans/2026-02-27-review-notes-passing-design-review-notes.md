# 审查对话记录 - review-notes 传递给模型

## 第1轮

### 外部模型反馈

**Qwen: CONCERNS**

#### 1. 完整性与正确性 (Completeness & Correctness)
- **上下文截断太随意**：计划里提到"截断到 2000 字符"。这是典型的懒政。2000 字符对于历史审查反馈来说可能连个函数名都装不下。如果上下文超限，应该由模型调用层处理（比如滑动窗口或摘要），而不是在加载层硬切。硬切会丢失关键信息，导致模型基于片面信息做判断，这是逻辑错误。
- **函数签名变更**：`audit_plan()` 需要接收 `plan_path`。请确认所有调用点都已更新。如果漏掉一个，运行时就会报错。这种耦合变更需要更严格的回归测试计划。

#### 2. 安全性 (Security - Destructive & Vulnerabilities)
- **路径遍历风险**：`plan_path` 如果来自用户输入，直接使用 `Path(plan_path)` 构建 `review_notes_path` 是危险的。攻击者可能传入 `../../etc/passwd` 类似的路径（虽然逻辑上是追加后缀，但需确保基目录锁定）。必须确保读取的文件在项目根目录范围内。
- **编码崩溃**：`read_text(encoding="utf-8")` 在遇到非 UTF-8 文件时会抛出异常。作为一个工具，不应该因为一个注释文件的编码问题就直接 crash。应该使用 `errors="replace"` 或 `errors="ignore"`，宁可显示乱码也不能让程序退出。

#### 3. 可逆性与最佳实践 (Reversibility & Best Practices)
- **CLI 参数的过度设计**：既然自动发现规则如此简单明确（同目录 + 固定后缀），为什么还需要 `--review-notes` 参数？"特殊情况不应打破常规"。如果自动发现能覆盖 99% 的场景，就不要为了那 1% 增加接口复杂度。如果真有需要，让用户改文件名符合规范，而不是改代码逻辑。
- **日志与调试**：加载了 review-notes 后，没有任何日志输出。如果加载失败或为空，开发者无从知晓。应该加一行简单的 debug 日志，说明是否成功加载了上下文。

#### 4. 好品味 (Good Taste)
- **魔法数字**：2000 字符是典型的魔法数字。为什么不是 1000？为什么不是 4096？这种没有物理意义的限制是代码腐化的开始。
- **静默失败**：文件不存在时 silent skip 是可以接受的（首轮审计），但编码错误或权限错误也应该 silent skip 吗？建议区分"正常不存在"和"异常无法读取"。

### 我的回应

Qwen 的反馈很准确。我来更新设计：

1. **移除硬截断** - 去掉 2000 字符限制，让 call_qwen/call_gemini 层处理 token 超限
2. **加固文件读取** - 使用 `errors="replace"` 防止编码崩溃
3. **移除 CLI 参数** - 保持接口简洁，砍掉 --review-notes
4. **添加日志** - 加载成功/失败都有 debug 日志
5. **区分异常类型** - 文件不存在 vs 读取错误分别处理
